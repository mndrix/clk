#!/usr/bin/perl
use strict;
use warnings;
use IPC::Open2;

# process command line arguments
my $storing_entry = 1;
for ( my $i=0; $i <= $#ARGV; $i++ ) {
    if ( $ARGV[$i] eq '--output-only' ) {
        $storing_entry = 0;
        splice @ARGV, $i, 1;  # remove the processed argument
    }
}

my ( $pid, $reader, $writer );
if ($storing_entry) {    # send output to clk-store-entry
    $pid = open2( $reader, $writer, 'clk-store-entry', './play' );
}
else {                   # send output to STDOUT
    $writer = \*STDOUT;
}

# generate the entry time
my $time =  $ENV{CLK_TIME} || time;
my @parts = (gmtime $time)[ 0 .. 5];
$parts[4]++;  # use human-readable day
$parts[5] += 1900; # ... and year
printf {$writer} "time: %04d-%02d-%02dT%02d:%02d:%02dZ\n", reverse @parts;

# generate the entry text
print {$writer} 'text: ' . join(' ', @ARGV)
    if @ARGV;

# if storing the entry, output its entry ID
if ($storing_entry) {
    close $writer;    # send EOF
    my $entry_id = <$reader>;
    waitpid $pid, 0;
    print $entry_id if $entry_id;
}
